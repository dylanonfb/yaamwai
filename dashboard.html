<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-width: 900px;
        width: 100%;
      }
      .authorized {
        color: #28a745;
      }
      .unauthorized {
        color: #dc3545;
      }
      .tabs {
        display: flex;
        border-bottom: 2px solid #667eea;
        margin-bottom: 20px;
      }
      .tab-button {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
      }
      .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }
      .tab-button:hover {
        color: #667eea;
      }
      .tab-content {
        display: none;
        overflow-x: auto;
      }
      .tab-content.active {
        display: block;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        min-width: 300px;
      }
      table th,
      table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        word-break: break-word;
      }
      table th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #333;
        position: sticky;
        top: 0;
      }
      table tr:hover {
        background-color: #f5f5f5;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #667eea;
      }
      .error {
        color: #dc3545;
        padding: 20px;
        text-align: center;
      }
      .drill-down-container {
        margin-top: 20px;
      }
      .drill-down-nav {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        gap: 10px;
        flex-wrap: wrap;
      }
      .drill-down-nav button {
        padding: 8px 12px;
        background-color: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }
      .drill-down-nav button:hover {
        background-color: #764ba2;
      }
      .drill-down-nav button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .drill-down-nav span {
        color: #666;
        font-weight: bold;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }
      .grid-item {
        padding: 15px;
        border: 2px solid #667eea;
        border-radius: 4px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background-color: white;
      }
      .grid-item:hover {
        background-color: #667eea;
        color: white;
        transform: translateY(-2px);
      }
      .grid-item-label {
        font-weight: bold;
        font-size: 16px;
      }
      .grid-item-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .grid-item:hover .grid-item-count {
        color: white;
      }
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .member-contributions-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .member-contribution-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
        text-align: center;
        transition: all 0.3s;
      }
      .member-contribution-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .member-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        font-size: 16px;
      }
      .member-amount {
        font-size: 24px;
        color: #667eea;
        font-weight: bold;
      }
      .contribution-total-info {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
        font-size: 18px;
        font-weight: bold;
        color: #667eea;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 20px;
          border-radius: 8px;
        }
        h1 {
          font-size: 24px;
          margin: 10px 0;
        }
        h3 {
          font-size: 18px;
          margin: 15px 0 10px 0;
        }
        .tabs {
          flex-wrap: wrap;
          border-bottom: 2px solid #667eea;
        }
        .tab-button {
          padding: 10px 12px;
          font-size: 13px;
          flex: 1;
          min-width: 100px;
          text-align: center;
        }
        table {
          font-size: 13px;
          margin-top: 15px;
        }
        table th,
        table td {
          padding: 8px 6px;
        }
        .dashboard-header {
          flex-direction: column;
          gap: 20px;
          margin-bottom: 20px;
        }
        .grid-container {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 8px;
        }
        .grid-item {
          padding: 10px;
          font-size: 13px;
        }
        .grid-item-label {
          font-size: 14px;
        }
        .grid-item-count {
          font-size: 11px;
        }
        .member-contributions-list {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 10px;
        }
        .member-contribution-card {
          padding: 15px;
        }
        .member-name {
          font-size: 14px;
          margin-bottom: 8px;
        }
        .member-amount {
          font-size: 18px;
        }
        .contribution-total-info {
          font-size: 16px;
          padding-top: 15px;
          margin-top: 15px;
        }
        .drill-down-container {
          margin-top: 15px;
        }
        .drill-down-nav {
          gap: 8px;
        }
        .drill-down-nav button {
          padding: 6px 10px;
          font-size: 12px;
        }
        .drill-down-nav span {
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 5px;
        }
        .container {
          padding: 15px;
          max-width: 100%;
          border-radius: 6px;
        }
        h1 {
          font-size: 20px;
          margin: 8px 0;
        }
        h3 {
          font-size: 16px;
          margin: 12px 0 8px 0;
        }
        .tabs {
          flex-wrap: wrap;
          margin-bottom: 15px;
        }
        .tab-button {
          padding: 8px 6px;
          font-size: 11px;
          flex: 1;
          min-width: 80px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .dashboard-header {
          flex-direction: column;
          gap: 15px;
          margin-bottom: 15px;
          align-items: center;
        }
        table {
          font-size: 12px;
          margin-top: 12px;
        }
        table th,
        table td {
          padding: 6px 4px;
          font-size: 11px;
        }
        .grid-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
        .grid-item {
          padding: 12px 8px;
          font-size: 11px;
        }
        .grid-item-label {
          font-size: 13px;
        }
        .grid-item-count {
          font-size: 10px;
        }
        .member-contributions-list {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        .member-contribution-card {
          padding: 12px;
        }
        .member-name {
          font-size: 13px;
          margin-bottom: 6px;
        }
        .member-amount {
          font-size: 16px;
        }
        .contribution-total-info {
          font-size: 14px;
          padding-top: 12px;
          margin-top: 12px;
        }
        .loading {
          padding: 15px;
          font-size: 14px;
        }
        .error {
          padding: 15px;
          font-size: 13px;
        }
        .drill-down-container {
          margin-top: 12px;
        }
        .drill-down-nav {
          flex-direction: column;
          gap: 10px;
        }
        .drill-down-nav button {
          width: 100%;
          padding: 8px;
          font-size: 12px;
        }
        .drill-down-nav span {
          font-size: 12px;
          text-align: center;
        }
      }

      /* Extra small devices */
      @media (max-width: 360px) {
        .container {
          padding: 12px;
        }
        h1 {
          font-size: 18px;
        }
        h3 {
          font-size: 14px;
        }
        .tab-button {
          padding: 6px 4px;
          font-size: 10px;
        }
        table th,
        table td {
          padding: 5px 3px;
          font-size: 10px;
        }
        .member-contributions-list {
          gap: 8px;
        }
        .member-contribution-card {
          padding: 10px;
        }
        .member-amount {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="content"></div>
    </div>

    <script>
      let authToken = null;
      let contributionData = {
        contributions: [],
        totalAmount: 0,
        drillDownActive: false
      };

      // Validate token with API
      async function validateToken() {
        try {
          authToken = localStorage.getItem("authToken");

          if (!authToken) {
            showUnauthorized();
            return;
          }

          const response = await fetch("https://api.yaamwai.in/authorize", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            showDashboard();
          } else {
            showUnauthorized();
          }
        } catch (error) {
          console.error("Token validation error:", error);
          showUnauthorized();
        }
      }

      function showUnauthorized() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <h1 class="unauthorized">Unauthorized</h1>
                <p>You do not have permission to access this dashboard.</p>
                <p>Please contact the administrator.</p>
            `;
      }

      function showDashboard() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="authorized">Dashboard</h1>
                </div>
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('members')">Member List</button>
                    <button class="tab-button" onclick="switchTab('attendance')">Member Attendance</button>
                    <button class="tab-button" onclick="switchTab('meetups')">Meetups</button>
                    <button class="tab-button" onclick="switchTab('contributions')">Contributions [<span id="totalContributionBracket">₹0</span>]</button>
                </div>
                <div id="members" class="tab-content active">
                    <div class="loading">Loading members...</div>
                </div>
                <div id="attendance" class="tab-content">
                    <div class="loading">Loading attendance data...</div>
                </div>
                <div id="contributions" class="tab-content">
                    <div class="loading">Loading contributions...</div>
                </div>
                <div id="meetups" class="tab-content">
                    <div class="loading">Loading meetups...</div>
                </div>
            `;

        // Load data for both tabs
        loadMembers();
        loadAttendance();
        loadMeetups();
        loadContributions();
      }

      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active class from all buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      async function loadMembers() {
        try {
          const response = await fetch("https://api.yaamwai.in/members/", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) throw new Error("Failed to fetch members");

          const members = await response.json();
          const membersDiv = document.getElementById("members");

          if (members.length === 0) {
            membersDiv.innerHTML = "<p>No members found.</p>";
            return;
          }

          let html =
            "<table><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody>";
          members.forEach((member) => {
            html += `
                        <tr ">
                            <td>${member.id}</td>
                            <td>${member.name}</td>
                        </tr>
                    `;
          });
          html += "</tbody></table>";

          membersDiv.innerHTML = html;
        } catch (error) {
          console.error("Error loading members:", error);
          document.getElementById("members").innerHTML =
            `<div class="error">Error loading members: ${error.message}</div>`;
        }
      }

      let attendanceState = {
        view: "years",
        selectedYear: null,
        selectedMonth: null,
        data: null,
        memberId: 12,
      };

      async function loadAttendance() {
        try {
          const response = await fetch("https://api.yaamwai.in/attendance-all/", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) throw new Error("Failed to fetch attendance");

          attendanceState.data = await response.json();
          displayAttendanceYears();
        } catch (error) {
          console.error("Error loading attendance:", error);
          document.getElementById("attendance").innerHTML =
            `<div class="error">Error loading attendance: ${error.message}</div>`;
        }
      }

      function displayAttendanceYears() {
        const attendanceDiv = document.getElementById("attendance");

        if (!attendanceState.data || attendanceState.data.length === 0) {
          attendanceDiv.innerHTML = "<p>No attendance records found.</p>";
          return;
        }

        const yearMap = {};
        attendanceState.data.forEach((record) => {
          if (!yearMap[record.year]) {
            yearMap[record.year] = 0;
          }
          yearMap[record.year]++;
        });

        let html = `<div class="drill-down-container">`;
        html += `<h3>Select Year</h3>`;
        html += `<div class="grid-container">`;

        Object.keys(yearMap)
          .sort((a, b) => b - a)
          .forEach((year) => {
            html += `
                    <div class="grid-item" onclick="displayAttendanceMonths(${year})">
                        <div class="grid-item-label">${year}</div>
                        <div class="grid-item-count">${yearMap[year]} records</div>
                    </div>
                `;
          });

        html += `</div></div>`;
        attendanceDiv.innerHTML = html;
      }

      function displayAttendanceMonths(year) {
        attendanceState.selectedYear = year;
        const attendanceDiv = document.getElementById("attendance");

        const monthMap = {};
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        attendanceState.data.forEach((record) => {
          if (record.year === year) {
            if (!monthMap[record.month]) {
              monthMap[record.month] = 0;
            }
            monthMap[record.month]++;
          }
        });

        let html = `<div class="drill-down-container">`;
        html += `<div class="drill-down-nav">`;
        html += `<button onclick="displayAttendanceYears()">← Back to Years</button>`;
        html += `<span>Year: ${year}</span>`;
        html += `</div>`;
        html += `<h3>Select Month</h3>`;
        html += `<div class="grid-container">`;

        Object.keys(monthMap)
          .sort((a, b) => a - b)
          .forEach((month) => {
            const monthName = monthNames[month - 1];
            html += `
                    <div class="grid-item" onclick="displayMonthDetails(${year}, ${month})">
                        <div class="grid-item-label">${monthName}</div>
                        <div class="grid-item-count">${monthMap[month]} records</div>
                    </div>
                `;
          });

        html += `</div></div>`;
        attendanceDiv.innerHTML = html;
      }

      function displayMonthDetails(year, month) {
        attendanceState.selectedYear = year;
        attendanceState.selectedMonth = month;
        const attendanceDiv = document.getElementById("attendance");
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const monthRecords = attendanceState.data.filter(
          (r) => r.year === year && r.month === month,
        );

        let html = `<div class="drill-down-container">`;
        html += `<div class="drill-down-nav">`;
        html += `<button onclick="displayAttendanceMonths(${year})">← Back to Months</button>`;
        html += `<span>${monthNames[month - 1]} ${year}</span>`;
        html += `</div>`;

        if (monthRecords.length === 0) {
          html += `<p>No records for this month.</p>`;
        } else {
          html += `<table><thead><tr><th>Member</th><th>Present</th><th>Date</th></tr></thead><tbody>`;
            console.log(monthRecords);
          monthRecords.forEach((record) => {
            html += `
                        <tr>
                            <td>${record.name}</td>
                            <td>${record.present == 'P' ? "✅ Yes" : "❌ No"}</td>
                            <td>${record.year}-${String(record.month).padStart(2, "0")}</td>
                        </tr>
                    `;
          });
          html += `</tbody></table>`;
        }

        html += `</div>`;
        attendanceDiv.innerHTML = html;
      }

      async function loadMeetups() {
        toLocalDate = (date) => {
          const dateString = date;
          const dateObj = new Date(dateString);

          const formattedDate = dateObj.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          console.log(formattedDate); // "January 1, 2025"
          return formattedDate;
        };

        try {
          const response = await fetch("https://api.yaamwai.in/meetups/", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) throw new Error("Failed to fetch meetups");

          const meetups = await response.json();
          const meetupsDiv = document.getElementById("meetups");

          if (meetups.length === 0) {
            meetupsDiv.innerHTML = "<p>No meetups found.</p>";
            return;
          }

          let html =
            "<table><thead><tr><th>Host</th><th>Date</th></tr></thead><tbody>";
          meetups.forEach((meetup) => {
            html += `
                        <tr>
                            <td>${meetup.host_name}</td>
                            <td>${toLocalDate(meetup.meetup_date)}</td>
                        </tr>
                    `;
          });
          html += "</tbody></table>";

          meetupsDiv.innerHTML = html;
        } catch (error) {
          console.error("Error loading meetups:", error);
          document.getElementById("meetups").innerHTML =
            `<div class="error">Error loading meetups: ${error.message}</div>`;
        }
      }

      async function loadContributions() {
        try {
          const response = await fetch("https://api.yaamwai.in/contributions/", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) throw new Error("Failed to fetch contributions");

          const data = await response.json();
          
          // Store contribution data for drill-down
          contributionData.contributions = data || [];
          
          // Calculate total contribution
          const total = contributionData.contributions.reduce((sum, item) => sum + (item.total_amount || 0), 0);
          contributionData.totalAmount = total;
          
          // Update bracket display in tab
          const bracketElement = document.getElementById("totalContributionBracket");
          if (bracketElement) {
            bracketElement.textContent = `₹${total}`;
          }
          
          // Display contributions in the tab
          displayContributionsTab();
        } catch (error) {
          console.error("Error loading contributions:", error);
          document.getElementById("contributions").innerHTML = `<div class="error">Error loading contributions: ${error.message}</div>`;
        }
      }

      function displayContributionsTab() {
        const contributionsDiv = document.getElementById("contributions");
        
        if (!contributionData.contributions || contributionData.contributions.length === 0) {
          contributionsDiv.innerHTML = '<p>No contribution data found.</p>';
          return;
        }

        let html = `<h3>Individual Member Contributions</h3>`;
        html += `<div class="contribution-total-info">Total Contribution: ₹${contributionData.totalAmount}</div>`;
        html += `<div class="member-contributions-list">`;
        
        contributionData.contributions.forEach(member => {
          html += `
            <div class="member-contribution-card">
              <div class="member-name">${member.member_name}</div>
              <div class="member-amount">₹${member.total_amount}</div>
            </div>
          `;
        });
        
        html += `</div>`;
        
        
        contributionsDiv.innerHTML = html;
      }

      // Run authorization check on page load
      window.addEventListener("DOMContentLoaded", validateToken);
    </script>
  </body>
</html>
